<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Power Guard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background: #0f172a; color: white; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid #334155; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: #1e293b; padding: 25px; border-radius: 16px; border: 1px solid #334155; text-align: center; }
        .val { font-size: 3rem; font-weight: 800; margin: 10px 0; color: #38bdf8; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .normal { background: #065f46; color: #34d399; }
        .anomaly { background: #7f1d1d; color: #f87171; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #chart-wrapper { background: #1e293b; padding: 20px; border-radius: 16px; margin-top: 20px; height: 350px; }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âš¡ AI Power Guard</h2>
        <button onclick="enableNotifications()">ðŸ”” Enable Alerts</button>
    </div>

    <div class="grid">
        <div class="card">
            <div style="color: #94a3b8;">AC Frequency</div>
            <div id="freqVal" class="val">--.-- Hz</div>
            <span id="freqStatus" class="status-badge normal">INITIALIZING</span>
        </div>
        <div class="card">
            <div style="color: #94a3b8;">AC Voltage</div>
            <div id="voltVal" class="val">---.- V</div>
            <span id="voltStatus" class="status-badge normal">INITIALIZING</span>
        </div>
    <div class="card">
    <div style="color: #94a3b8;">Session Peaks</div>
    <div style="display: flex; justify-content: space-around; margin-top: 15px;">
        <div>
            <small>MAX VOLT</small>
            <div id="maxV" style="color: #fbbf24; font-weight: bold;">0 V</div>
        </div>
        <div>
            <small>MIN VOLT</small>
            <div id="minV" style="color: #60a5fa; font-weight: bold;">0 V</div>
        </div>
    </div>
</div>

<div class="card">
    <div style="color: #94a3b8;">System Health</div>
    <div id="uptime" style="font-size: 1.2rem; margin-top: 10px;">UP: 00:00:00</div>
    <div id="lastSync" style="font-size: 0.8rem; color: #64748b;">Last Sync: Just now</div>
</div>
    </div>

    <div id="chart-wrapper">
        <canvas id="powerChart"></canvas>
    </div>
</div>

<script>
    // PASTE YOUR GOOGLE SCRIPT DEPLOYMENT URL HERE
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbydU2cT7eXUums153MSWc3l3AZDxN4kosGqM2bvBOP9KYce9mZos7d4v6jPStpSPdYY/exec"; 
    
    let powerChart;

    function initChart() {
        const ctx = document.getElementById('powerChart').getContext('2d');
        powerChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Freq (Hz)', data: [], borderColor: '#38bdf8', yAxisID: 'y' },
                { label: 'Volt (V)', data: [], borderColor: '#fbbf24', yAxisID: 'y1' }
            ]},
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: { 
                    y: { position: 'left', grid: { color: '#334155' } },
                    y1: { position: 'right', grid: { display: false } }
                }
            }
        });
    }

    async function fetchData() {
        try {
            // Browsers handle the Google redirect automatically
            const response = await fetch(GAS_API_URL);
            const data = await response.json();
            updateUI(data);
        } catch (error) {
            console.error("Fetch error:", error);
        }
    }

    let maxVolt = 0;
let minVolt = 999;
let startTime = Date.now();
    
    function updateUI(data) {
        if (!data || data.length === 0) return;
        const latest = data[data.length - 1];

        // Update Values
        document.getElementById('freqVal').innerText = latest.freq.toFixed(2) + " Hz";
        document.getElementById('voltVal').innerText = latest.volt.toFixed(1) + " V";

        // Update Badges & Check for Alerts
        const fBadge = document.getElementById('freqStatus');
        fBadge.innerText = latest.freqState;
        fBadge.className = "status-badge " + (latest.freqState === "ANOMALY" ? "anomaly" : "normal");

        const vBadge = document.getElementById('voltStatus');
        vBadge.innerText = latest.voltState;
        vBadge.className = "status-badge " + (latest.voltState === "ANOMALY" ? "anomaly" : "normal");

        // Trigger Notification if Anomaly
        if (latest.freqState === "ANOMALY" || latest.voltState === "ANOMALY") {
            sendNotification(latest.freq, latest.volt);
        }
        
        // Add this inside the anomaly detection block in your HTML script
    if (latest.freqState === "ANOMALY" || latest.voltState === "ANOMALY") {
    // This creates a short beep even if the screen is off
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioCtx.createOscillator();
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); // 440Hz beep
    oscillator.connect(audioCtx.destination);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.5); // Beep for 0.5 seconds
    }

        // Update Chart
        powerChart.data.labels = data.map(d => d.time);
        powerChart.data.datasets[0].data = data.map(d => d.freq);
        powerChart.data.datasets[1].data = data.map(d => d.volt);
        powerChart.update('none');


    if (!data || data.length === 0) return;
    const latest = data[data.length - 1];

    // 1. Update Min/Max
    if (latest.volt > maxVolt) maxVolt = latest.volt;
    if (latest.volt < minVolt && latest.volt > 0) minVolt = latest.volt;
    document.getElementById('maxV').innerText = maxVolt.toFixed(1) + " V";
    document.getElementById('minV').innerText = minVolt.toFixed(1) + " V";

    // 2. Update Quality Color Coding
    const fBadge = document.getElementById('freqStatus');
    // Using the quality strings from Apps Script
    fBadge.innerText = latest.freqQuality; 
    setQualityColor(fBadge, latest.freqQuality);

    // 3. Update Uptime
    const diff = Math.floor((Date.now() - startTime) / 1000);
    const hrs = Math.floor(diff / 3600).toString().padStart(2, '0');
    const mins = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
    const secs = (diff % 60).toString().padStart(2, '0');
    document.getElementById('uptime').innerText = `UP: ${hrs}:${mins}:${secs}`;
        
    }

    function enableNotifications() {
        Notification.requestPermission().then(perm => {
            if (perm === 'granted') {
                new Notification("Notifications Enabled", { body: "You will now receive power quality alerts." });
            }
        });
    }

function sendNotification(f, v) {
    if (Notification.permission === 'granted') {
        const options = {
            body: `Freq: ${f}Hz | Volt: ${v}V detected!`,
            icon: "https://cdn-icons-png.flaticon.com/512/355/355980.png",
            vibrate: [200, 100, 200], // Vibration pattern: 200ms on, 100ms off, 200ms on
            badge: "https://cdn-icons-png.flaticon.com/512/355/355980.png", // Icon in status bar
            tag: 'power-anomaly', // Prevents multiple notification spam
            renotify: true // Makes the phone vibrate again for new anomalies
        };
        
        new Notification("âš ï¸ POWER ANOMALY", options);
    }
}

    // 1. Register the Service Worker on Load
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
    }, function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}

// 2. Updated Notification Function
function sendNotification(f, v) {
  if (Notification.permission === 'granted') {
    navigator.serviceWorker.ready.then(function(registration) {
      registration.showNotification("âš ï¸ POWER ANOMALY", {
        body: `Freq: ${f}Hz | Volt: ${v}V detected!`,
        icon: "https://cdn-icons-png.flaticon.com/512/355/355980.png",
        vibrate: [200, 100, 200],
        tag: 'power-anomaly',
        renotify: true
      });
    });
  }
}

// 3. Keep your Enable button the same
function enableNotifications() {
  Notification.requestPermission().then(perm => {
    if (perm === 'granted') {
      sendNotification("System", "Active");
    }
  });
}




function setQualityColor(element, quality) {
    const colors = {
        "Excellent": "#065f46",
        "Stable": "#0369a1",
        "Warning": "#92400e",
        "Critical": "#991b1b",
        "Unstable": "#92400e",
        "Damaging": "#991b1b"
    };
    element.style.backgroundColor = colors[quality] || "#334155";
}
    

    window.onload = () => {
        initChart();
        fetchData();
        setInterval(fetchData, 5000); // Sync every 5 seconds
    };
</script>

</body>
</html>
