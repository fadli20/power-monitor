<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Power Guard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --border: #334155;
            --accent: #38bdf8;
            --success: #34d399;
            --danger: #f87171;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--border); text-align: center; position: relative; overflow: hidden; }
        .val { font-size: 2.8rem; font-weight: 800; margin: 10px 0; color: var(--accent); }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .normal { background: #065f46; color: var(--success); }
        .anomaly { background: #7f1d1d; color: var(--danger); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        #chart-wrapper { background: var(--card); padding: 20px; border-radius: 16px; margin-top: 20px; height: 350px; border: 1px solid var(--border); }
        .btn-group { display: flex; gap: 10px; }
        button { background: #3b82f6; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        .secondary { background: #475569; }
        .heartbeat { width: 10px; height: 10px; background: var(--success); border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 10px var(--success); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>âš¡ AI Power Guard</h2>
        <div class="btn-group">
            <button class="secondary" onclick="downloadCSV()">ðŸ“¥ Export CSV</button>
            <button onclick="enableNotifications()">ðŸ”” Enable Alerts</button>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div style="color: #94a3b8;">Frequency</div>
            <div id="freqVal" class="val">--.-- Hz</div>
            <span id="freqStatus" class="status-badge normal">INIT</span>
        </div>
        
        <div class="card">
            <div style="color: #94a3b8;">Voltage</div>
            <div id="voltVal" class="val">---.- V</div>
            <span id="voltStatus" class="status-badge normal">INIT</span>
        </div>

        <div class="card">
            <div style="color: #94a3b8;">Session Peaks</div>
            <div style="display: flex; justify-content: space-around; margin-top: 15px;">
                <div><small>MAX</small><div id="maxV" style="color: #fbbf24; font-weight: bold;">0V</div></div>
                <div><small>MIN</small><div id="minV" style="color: #60a5fa; font-weight: bold;">0V</div></div>
            </div>
        </div>

        <div class="card">
            <div style="color: #94a3b8;">System Health</div>
            <div id="uptime" style="font-size: 1.1rem; margin-top: 10px; font-weight: bold;">UP: 00:00:00</div>
            <div id="lastSync" style="font-size: 0.8rem; color: #64748b; margin-top: 5px;">
                <span class="heartbeat"></span>Synced: --:--
            </div>
        </div>
    </div>

    <div id="chart-wrapper">
        <canvas id="powerChart"></canvas>
    </div>
</div>

<script>
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbydU2cT7eXUums153MSWc3l3AZDxN4kosGqM2bvBOP9KYce9mZos7d4v6jPStpSPdYY/exec"; 
    
    let powerChart;
    let maxVolt = 0;
    let minVolt = 999;
    let startTime = Date.now();
    let lastReceivedData = [];

    // Register Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW failed', err));
        });
    }

    function initChart() {
        const ctx = document.getElementById('powerChart').getContext('2d');
        powerChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [
                { label: 'Freq (Hz)', data: [], borderColor: '#38bdf8', yAxisID: 'y', tension: 0.3, pointRadius: 0 },
                { label: 'Volt (V)', data: [], borderColor: '#fbbf24', yAxisID: 'y1', tension: 0.3, pointRadius: 0 }
            ]},
            options: { 
                responsive: true, maintainAspectRatio: false,
                scales: { 
                    y: { position: 'left', grid: { color: '#334155' }, title: {display: true, text: 'Hz', color: '#94a3b8'} },
                    y1: { position: 'right', grid: { display: false }, title: {display: true, text: 'Volts', color: '#94a3b8'} }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });
    }

    async function fetchData() {
        try {
            const response = await fetch(GAS_API_URL);
            const data = await response.json();
            if (data && data.length > 0) {
                lastReceivedData = data;
                updateUI(data);
            }
        } catch (error) { console.error("Fetch error:", error); }
    }

    function updateUI(data) {
        const latest = data[data.length - 1];

        // 1. Core Values
        document.getElementById('freqVal').innerText = latest.freq.toFixed(2) + " Hz";
        document.getElementById('voltVal').innerText = latest.volt.toFixed(1) + " V";
        document.getElementById('lastSync').innerHTML = `<span class="heartbeat"></span>Synced: ${latest.time}`;

        // 2. Peaks
        if (latest.volt > maxVolt) maxVolt = latest.volt;
        if (latest.volt < minVolt && latest.volt > 50) minVolt = latest.volt;
        document.getElementById('maxV').innerText = maxVolt.toFixed(1) + " V";
        document.getElementById('minV').innerText = minVolt.toFixed(1) + " V";

        // 3. Status Badges & Colors
        const fBadge = document.getElementById('freqStatus');
        const vBadge = document.getElementById('voltStatus');
        
        fBadge.innerText = latest.freqQuality || latest.freqState;
        vBadge.innerText = latest.voltQuality || latest.voltState;

        setQualityStyle(fBadge, latest.freqQuality || latest.freqState);
        setQualityStyle(vBadge, latest.voltQuality || latest.voltState);

        // 4. Notifications & Audio
        if (latest.freqState === "ANOMALY" || latest.voltState === "ANOMALY") {
            triggerAlert(latest.freq, latest.volt);
        }

        // 5. Uptime
        const diff = Math.floor((Date.now() - startTime) / 1000);
        const hrs = Math.floor(diff / 3600).toString().padStart(2, '0');
        const mins = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
        const secs = (diff % 60).toString().padStart(2, '0');
        document.getElementById('uptime').innerText = `UP: ${hrs}:${mins}:${secs}`;

        // 6. Chart Update
        powerChart.data.labels = data.map(d => d.time);
        powerChart.data.datasets[0].data = data.map(d => d.freq);
        powerChart.data.datasets[1].data = data.map(d => d.volt);
        powerChart.update('none');
    }

    function setQualityStyle(el, status) {
        el.className = "status-badge"; // reset
        if (status === "ANOMALY" || status === "Critical" || status === "Damaging") {
            el.classList.add("anomaly");
        } else {
            el.classList.add("normal");
            const colors = { "Excellent": "#065f46", "Stable": "#0369a1", "Warning": "#92400e" };
            el.style.backgroundColor = colors[status] || "#065f46";
        }
    }

    function triggerAlert(f, v) {
        // Audio Beep
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.3);

        // Notification
        if (Notification.permission === 'granted') {
            navigator.serviceWorker.ready.then(reg => {
                reg.showNotification("âš ï¸ POWER ANOMALY", {
                    body: `Freq: ${f}Hz | Volt: ${v}V detected!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/355/355980.png",
                    vibrate: [200, 100, 200],
                    tag: 'power-anomaly',
                    renotify: true
                });
            });
        }
    }

    function enableNotifications() {
        Notification.requestPermission().then(perm => {
            if (perm === 'granted') {
                new Notification("âœ… Notifications Enabled");
            }
        });
    }

    function downloadCSV() {
        if (lastReceivedData.length === 0) return;
        let csv = "Time,Frequency,Voltage\n";
        lastReceivedData.forEach(row => {
            csv += `${row.time},${row.freq},${row.volt}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'power_data.csv');
        a.click();
    }

    window.onload = () => {
        initChart();
        fetchData();
        setInterval(fetchData, 5000);
    };
</script>

</body>
</html>
